#!/bin/bash
log_file="/var/log/backup-for-{{ backup_client_user }}.log"
ret_file="/var/log/backup-for-{{ backup_client_user }}.ret"

> "${log_file}"
> "${ret_file}"

function backup() {
{% for backup_server in groups['backup_server'] %}
{% if hostvars[inventory_hostname]['backup_paths'][backup_client_user] is defined %}
{% for backup_path in hostvars[inventory_hostname]['backup_paths'][backup_client_user] %}
  echo
  echo
  echo "Backing up {{ backup_path }}:"
  time rsync -rlpR "{{ backup_path }}/" "{{backup_client_user}}-at-{{ inventory_hostname}}@{{ backup_server }}":"{{ backup_prefix }}/{{ inventory_hostname }}/{{ backup_client_user }}/"
  echo "${?}" >> "${ret_file}"
{% endfor %}
{% endif %}
{% endfor %}
}

backup > "${log_file}" 2>&1
